<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/html/polymer/wallpaper-header.html">
<link rel="import" href="/html/polymer/wallpaper-display.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">


<dom-module id="wallpaper-app">
  <template>
    <style>
      #results-div {
        margin-top: 100px;
      }
    </style>
    <iron-request id="xhr" response="{{wallpaperResponse}}"></iron-request>
    <wallpaper-header subreddits="{{subreddits}}" on-refresh="refresh"></wallpaper-header>
    <div id="results-div">
      <template is="dom-repeat" items="{{wallpapers}}">
        <wallpaper-display
          url="[[item.url]]"
          reddit-url="[[item.redditUrl]]"
          thumbnail="[[item.thumbnail]]">
        </wallpaper-display>
      </template>
    </div>
  </template>

  <script>
    Polymer({
      is: 'wallpaper-app',

      properties: {
        lastId: String,

        subreddits: {
          type: Array,
          value: () => ['wallpaper', 'wallpapers', 'minimalwallpaper'],
        },

        wallpapers: {
          type: Array,
          value: () => [],
        },

        wallpaperResponse: {
          type: Object,
          observer: 'handleWallpaperResponseChanged'
        },
      },

      ready() {
        this.requestMoreWallpaper();
      },

      refresh() {
        this.wallpapers = [];
        this.requestMoreWallpaper();
      },

      requestMoreWallpaper() {
        // TODO: this needs to send the lastId along
        // May have to switch to iron-xhr
        this.$.xhr.send({'url': 'results'});
      },

      handleWallpaperResponseChanged() {
        if (!this.wallpaperResponse) {
          return;
        }

        var results = JSON.parse(this.wallpaperResponse);
        
        if (!results || !results.success) {
          console.log('Wallpapers request failed.');
          return;
        }

        var images = results.data.images;
        images.forEach((image) => {
          let wallpaper = {
              url: image.image_link,
              redditUrl: 'http://www.reddit.com' + image.reddit_link,
              thumbnail: image.thumbnail,
          };
          this.push('wallpapers', wallpaper);
        }); 

        this.lastId = images[images.length - 1].name;
      }
    });
  </script>
</dom-module>
