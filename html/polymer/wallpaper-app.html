<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/html/polymer/wallpaper-header.html">
<link rel="import" href="/html/polymer/wallpaper-display.html">


<dom-module id="wallpaper-app">
  <template>
    <style>
      #loadmore-button {
        background: darkblue;
        color: white;
        font-family: RobotoDraft, 'Helvetica Neue', Helvetica, Arial;
        text-transform: none;
        margin-right: 50%;
        margin-left: 50%;
        width: 100px;
      }

      #results-div {
        margin-top: 100px;
      }
    </style>
    <iron-ajax id="xhr" url="/results" last-response="{{wallpaperResponse}}"></iron-ajax>
    <wallpaper-header
        subreddits="{{subreddits}}"
        sort="{{sort}}"
        time="{{time}}"
        on-refresh="refresh">
    </wallpaper-header>
    <div id="results-div">
      <template is="dom-repeat" items="{{wallpapers}}">
        <wallpaper-display
          url="[[item.url]]"
          reddit-url="[[item.redditUrl]]"
          thumbnail="[[item.thumbnail]]">
        </wallpaper-display>
      </template>
    </div>
    <paper-button raised id="loadmore-button" on-tap="requestMoreWallpaper">Load More</paper-button>
  </template>

  <script>
    Polymer({
      is: 'wallpaper-app',

      properties: {
        lastId: String,

        sort: {
          type: String,
          value: 'hot'
        },

        time: String,

        subreddits: {
          type: Array,
          value: () => ['wallpaper', 'wallpapers', 'minimalwallpaper'],
        },

        wallpapers: {
          type: Array,
          value: () => [],
        },

        wallpaperResponse: {
          type: Object,
          observer: 'handleWallpaperResponseChanged'
        },
      },

      ready() {
        this.requestMoreWallpaper();
      },

      refresh() {
        this.lastId = null;
        this.wallpapers = [];
        this.requestMoreWallpaper();
      },

      requestMoreWallpaper() {
        this.$.xhr.params = {
          after: this.lastId ? this.lastId : '',
          sort: this.sort,
          time: this.time, 
          sub: this.subreddits,
        };
        this.$.xhr.generateRequest();
      },

      handleWallpaperResponseChanged() {
        if (!this.wallpaperResponse) {
          return;
        }
        
        if (!this.wallpaperResponse || !this.wallpaperResponse.success) {
          console.log('Wallpapers request failed.');
          return;
        }

        var images = this.wallpaperResponse.data.images;
        images.forEach((image) => {
          let wallpaper = {
              url: image.image_link,
              redditUrl: 'http://www.reddit.com' + image.reddit_link,
              thumbnail: image.thumbnail,
          };
          this.push('wallpapers', wallpaper);
        }); 

        this.lastId = images[images.length - 1].name;
      }
    });
  </script>
</dom-module>
